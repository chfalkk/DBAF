<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" type="image/x-icon" href="img/favicon.ico">
        <title>DBAF - Fahrplanauskunft</title>
        
        <!-- jQuery library -->
        <script type="text/javascript" src="dx_22.2.4/js/jquery.min.js"></script>
        <!-- DevExtreme theme -->
        <link rel="dx-theme" data-theme="generic.dark" href="dx_22.2.4/css/dx.dark.css" data-active="true">
        <!-- DevExtreme library -->
        <script type="text/javascript" src="dx_22.2.4/js/dx.all.js"></script>
        <!-- Dictionary files for German language -->
        <script type="text/javascript" src="dx_22.2.4/js/localization/dx.messages.de.js"></script>
        <!-- DBAF -->
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <script type="text/javascript" src="js/dbaf.js"></script>
        <script type="text/javascript" src="js/request.js"></script>
    </head>

    <body class="dx-viewport">
        <div class="dbaf-toolbar" id="toolbar"></div>

        <div class="dbaf-group-main">
            <!-- Übersicht der Seite -->
            <div class="dbaf-group">
                <h1>Fahrplanauskunft</h1>
                <p>
                    Mit der Eingabe eines Bahnhofes und dem Datum können alle Abfahrten und Ankünfte mit allen Daten an diesem Bahnhof angezeigt werden.
                </p>
                <hr>
            </div>

            <!-- Eingabeformular -->
            <form class="dbaf-group" id="form-container">
                <div id="fahrplanForm"></div>
            </form>

            <!-- Ergebnisse, wenn Anfrage abgeschickt wurde: -->
            <div class="dbaf-group" id="results">
                <hr>
                <div class="dbaf-group">
                    <h3>Übersicht</h3>
                    <p>Für diese Station ist ein stufenloser Eingang <span class="dbaf-text-bold" id="steplessAccess-status">... </span>.</p>
                </div>
                <h3>Abfahrten ab <span id="departures_name"></span></h3>
                <div class="dbaf-grid" id="departuresTable"></div>
                <h3>Ankunften in <span id="arrivals_name"></span></h3>
                <div class="dbaf-grid" id="arrivalsTable"></div>
            </div>
        </div>
    </body>
    
    <!-- NOSCRIPT CHECK -->
    <noscript>
        JavaScript muss aktiviert sein, um diese Website nutzen zu können!
    </noscript>
        
    <script type="text/javascript">
        // Anzeige aktivieren
        $(".dbaf-toolbar").show();
        $(".dbaf-group-main").show();
    </script>
    <!-- NOSCRIPT CHECK -->

    <script type="text/javascript">
        // Stationen abholen
        let aStationNames = [];
        let aStations = GetAllStations(FEDERALSTATE_ANY, (Data) => {
            // Stationsnamen speichern
            Data.forEach(element => {
                aStationNames.push(element.name);
            });

            // URL auslesen, falls targetStation als GET gesetzt wurde
            const sURL = window.location.search;
            const parURL = new URLSearchParams(sURL);
            const sTargetStation = parURL.get('targetStation');

            if (sTargetStation != null) {
                // TargetStation als Value setzen
                if (aStationNames.includes(sTargetStation)) {
                    eForm.getEditor("stations").option("value", sTargetStation);
                } else {
                    DevExpress.ui.notify("Zielbahnhof \"" + sTargetStation + "\" existiert nicht.", "warning", 1000);
                }
            }
        });

        // Eingabeformular
        let eForm = $("#fahrplanForm").dxForm({
            formData: {
                date: new Date() // Standardwert für die Datumseingabe: heute
            },
            colCount: 1,
            items: [{
                itemType: "group",
                caption: "Fahrplan-Suche",
                colCount: 1,
                items: [{
                    // Auswahlfeld für die gewünschte Station

                    dataField: "stations",
                    isRequired: true,
                    editorType: "dxSelectBox",
                    editorOptions: {
                        // Datenquelle
                        dataSource: new DevExpress.data.DataSource({
                            store: aStationNames,
                            paginate: true,
                            pageSize: 10,
                            sort: [  
                                { desc: false }  
                            ] 
                        }),
                        searchEnabled: true
                    },
                    label: {
                        text: "Startbahnhof"
                    },
                    validationRules: [{ type: "required" }]
                }, {
                    // Auswahl des Datums 

                    dataField: "date",
                    editorType: "dxDateBox",
                    label: {
                        text: "Datum"
                    },
                    validationRules: [{ type: "required" }]
                }, {
                    // Button für Bestätigung

                    itemType: "button",
                    buttonOptions: {
                        text: "Fahrplan laden",
                        useSubmitBehavior: true
                    }
                }]
            }]
        }).dxForm("instance");
 
        // Wenn Daten submitted wurden
        $("#form-container").on("submit", function(e) {
            // Fahrplandaten abholen
            let sStationName = eForm.getEditor("stations").option("value");
            let dTargetDate = eForm.getEditor("date").option("value");
            let aStationData = aStations[aStationNames.indexOf(sStationName)];

            // Anzeige aktualisieren
            $("#departures_name").text(sStationName);
            $("#arrivals_name").text(sStationName);

            // Stufenloser Eingang
            let sSteplessAccess = (aStationData.hasSteplessAccess == true ? "vorhanden" : "nicht vorhanden");
            $("#steplessAccess-status").text(sSteplessAccess);
            
            $("#results").show();

            // Daten für Abfahrten abholen
            GetAllDepartures(aStationData.ID, dTargetDate, (Data) => {
                // Daten aktualisieren
                eGridDepartures.option("dataSource", Data);
            });

            // Daten für Ankünfte abholen
            GetAllArrivals(aStationData.ID, dTargetDate, (Data) => {
                // Daten aktualisieren
                eGridArrivals.option("dataSource", Data);
            });

            // Standardevent verhindern
            e.preventDefault();
        });

        // Tabelle für alle Abfahrten
        let eGridDepartures = $("#departuresTable").dxDataGrid({
            dataSource: [],
            keyExpr: "ID",
            allowColumnResizing: true,
            allowColumnReordering: true,
            filterRow: { visible: true },
            searchPanel: { visible: true },
            loadPanel: { enabled: true },

            // Tabelle in Seiten unterteilen
            pager: {
                showPageSizeSelector: true,
                allowedPageSizes: [10, 20, 50, 100],
                showNavigationButtons: true
            },

            toolbar: {
                // Such-Option anzeigen
                items: [
                    "searchPanel"
                ]
            },

            // Spalten der Tabelle
            columns: [{
                dataField: "ID",
                visible: false
            }, {
                dataField: "plannedWhen",
                sortOrder: "asc", // Sortierung nach geplanter Abfahrt
                dataType: "datetime",
                caption: "Geplante Abfahrt (Prognose)"
            }, {
                dataField: "when",
                dataType: "datetime",
                caption: "Genaue Abfahrt"
            }, {
                dataField: "direction",
                caption: "Richtung"
            }, {
                dataField: "plannedPlatform",
                caption: "Plattform"
            }],
            
            // Zusammenfassung
            summary: {
                // Anzahl der Abfahrten anzeigen
                totalItems: [{
                    column: "plannedWhen",
                    summaryType: "count"
                }]
            }
        }).dxDataGrid("instance");

        // Tabelle für alle Ankünfte
        let eGridArrivals = $("#arrivalsTable").dxDataGrid({
            dataSource: [],
            keyExpr: "ID",
            allowColumnResizing: true,
            allowColumnReordering: true,
            filterRow: { visible: true },
            searchPanel: { visible: true },
            loadPanel: { enabled: true },

            // Tabelle in Seiten unterteilen
            pager: {
                showPageSizeSelector: true,
                allowedPageSizes: [10, 20, 50, 100],
                showNavigationButtons: true
            },

            toolbar: {
                // Such-Option anzeigen
                items: [
                    "searchPanel"
                ]
            },

            // Spalten der Tabelle
            columns: [{
                dataField: "ID",
                visible: false
            }, {
                dataField: "plannedWhen",
                sortOrder: "asc", // Sortierung nach der geplanten Ankunft
                dataType: "datetime",
                caption: "Geplante Ankunft (Prognose)"
            }, {
                dataField: "when",
                dataType: "datetime",
                caption: "Genaue Ankunft"
            }, {
                dataField: "provenance",
                caption: "Herkunft"
            }, {
                dataField: "plannedPlatform",
                caption: "Plattform"
            }],
            
            // Zusammenfassung
            summary: {
                // Anzahl der Ankünfte anzeigen
                totalItems: [{
                    column: "plannedWhen",
                    summaryType: "count"
                }]
            }
        }).dxDataGrid("instance");
    </script>
    
    <!-- Toolbareinstellungen laden -->
    <script type="text/javascript" src="js/toolbar.js"></script>
</html>