<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" type="image/x-icon" href="img/favicon.ico">
        <title>DBAF - Routenplaner</title>
        
        <!-- jQuery library -->
        <script type="text/javascript" src="dx_22.2.4/js/jquery.min.js"></script>
        <!-- DevExtreme theme -->
        <link rel="dx-theme" data-theme="generic.dark" href="dx_22.2.4/css/dx.dark.css" data-active="true">
        <!-- DevExtreme library -->
        <script type="text/javascript" src="dx_22.2.4/js/dx.all.js"></script>
        <!-- Dictionary files for German language -->
        <script type="text/javascript" src="dx_22.2.4/js/localization/dx.messages.de.js"></script>
        <!-- DBAF -->
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <script type="text/javascript" src="js/dbaf.js"></script>
        <script type="text/javascript" src="js/request.js"></script>
    </head>

    <body class="dx-viewport">
        <div class="dbaf-toolbar" id="toolbar"></div>

        <div class="dbaf-group-main">
            <!-- Übersicht der Seite -->
            <div class="dbaf-group">
                <h1>Routenplaner</h1>
                <p>
                    Im Routenplaner können Start- und Endstation und die gewünschte Startzeit eingegeben werden.<br>
                    Danach wird angezeigt, wie die nächstmögliche Route verläuft. In der Übersicht werden alle Daten zusammengefasst aufgelistet.
                </p>
                <hr>
            </div>

            <!-- Eingabeformular für die Routenplanung -->
            <form class="dbaf-group" id="form-container">
                <div id="routenplanerForm"></div>
            </form>

            <!-- Ergebnisse, wenn Anfrage abgeschickt wurde: -->
            <div class="dbaf-group" id="results">
                <hr>
                <div style="margin-bottom: 40px">
                    <!-- Übersicht -->
                    <h3>Übersicht</h3>
                    <p>Die voraussichtliche gesamte Trip-Zeit (Fahrt und zu Fuß) beträgt <span class="dbaf-text-bold" id="totalTripTime">... </span>.</p>
                    <p>Die voraussichtliche gesamte Wartezeit zwischen Stationen beträgt <span class="dbaf-text-bold" id="totalWaitTime">... </span>.</p>
                    <p>Die voraussichtliche gesamte Reisezeit beträgt <span class="dbaf-text-bold" id="totalTime">... </span>.</p>
                    <p>Die Route beinhaltet <span class="dbaf-text-bold" id="totalTransfers">...</span> Umstieg(e) bzw. Laufweg(e).</p>
                    <p id="price">Die voraussichtlichen Reisekosten betragen <span class="dbaf-text-bold">... </span>.</p>
                </div>
                <h3>Route von <span id="stationStart"></span> nach <span id="stationEnd"></span></h3>
                <div class="dbaf-grid" id="journeyTable"></div>
                <p class="dbaf-text-italic">Für diese Angaben wird keine Garantie übernommen, da sich Routenpläne ändern bzw. gestört werden können.</p>
            </div>
        </div>
    </body>
    
    <!-- DBAF-TODO: Auskommentierung ab hier -->

    <script type="text/javascript">
        // Stationen abholen
        let aStationNames = [];
        let aStations = GetAllStations(FEDERALSTATE_ANY, () => {
            aStations.forEach(element => {
                aStationNames.push(element.name);
            });
        });

        // alle Trips
        let aJourneys = [];

        // Eingabeformular
        let eForm = $("#routenplanerForm").dxForm({
            formData: {
                startDateTime: new Date()
            },
            colCount: 1,
            items: [{
                itemType: "group",
                caption: "Routenplanung erstellen",
                colCount: 1,
                items: [{
                    dataField: "stationsStart",
                    isRequired: true,
                    editorType: "dxSelectBox",
                    editorOptions: {
                        dataSource: new DevExpress.data.DataSource({
                            store: aStationNames,
                            paginate: true,
                            pageSize: 10
                        }),
                        searchEnabled: true
                    },
                    label: {
                        text: "Startbahnhof"
                    },
                    validationRules: [{ type: "required" }]
                }, {
                    dataField: "stationsEnd",
                    isRequired: true,
                    editorType: "dxSelectBox",
                    editorOptions: {
                        dataSource: new DevExpress.data.DataSource({
                            store: aStationNames,
                            paginate: true,
                            pageSize: 10
                        }),
                        searchEnabled: true
                    },
                    label: {
                        text: "Zielbahnhof"
                    },
                    validationRules: [{ type: "required" }]
                }, {
                    dataField: "startDateTime",
                    editorType: "dxDateBox",
                    editorOptions: {
                        type: "datetime"
                    },
                    label: {
                        text: "Start-Zeit"
                    },
                    validationRules: [{ type: "required" }]
                }, {
                    itemType: "button",
                    buttonOptions: {
                        text: "Route laden",
                        useSubmitBehavior: true
                    }
                }]
            }]
        }).dxForm("instance");
 
        // Wenn Daten submitted wurden
        $("#form-container").on("submit", function(e) {
            // Stationsnamen abholen
            let sStartStationName = eForm.getEditor("stationsStart").option("value");
            let sEndStationName = eForm.getEditor("stationsEnd").option("value");
            let dStart = eForm.getEditor("startDateTime").option("value");

            // Stationen müssen sich unterscheiden
            if (sStartStationName.localeCompare(sEndStationName) == 0) {
                alert("Start- und Endstation müssen sich voneinander unterscheiden!");
                e.preventDefault();
                return;
            }
            
            // Daten zu den Stationen laden
            let aStartStationData = aStations[aStationNames.indexOf(sStartStationName)];
            let aEndStationData = aStations[aStationNames.indexOf(sEndStationName)];

            // Daten anzeigen
            $("#totalTripTime").text("... ");
            $("#totalWaitTime").text("... ");
            $("#totalTime").text("... ");
            $("#totalTransfers").text("...");
            $("#price").html("Die voraussichtlichen Reisekosten betragen <span class=\"dbaf-text-bold\">... </span>.");
            $("#stationStart").text(sStartStationName);
            $("#stationEnd").text(sEndStationName);
            $("#results").show();

            // Daten für alle Trips holen
            aJourneys = GetAllJourneys(aStartStationData.ID, aEndStationData.ID, dStart, (TotalTripMins, TotalWaitingMins, Price) => {
                // Statistiken ausfüllen
                $("#totalTripTime").text(ConvertMinutesToStr(TotalTripMins, true));
                $("#totalWaitTime").text(ConvertMinutesToStr(TotalWaitingMins, true));
                $("#totalTime").text(ConvertMinutesToStr(TotalWaitingMins + TotalTripMins, true));
                $("#totalTransfers").text(aJourneys.length - 1);

                if (Price == null) {
                    $("#price").html("<span id=\"dbaf-text-italic\">Die voraussichtlichen Reisekosten konnten nicht ermittelt werden.</span>");
                } else {
                    $("#price").html("Die voraussichtlichen Reisekosten betragen <span class=\"dbaf-text-bold\">" + Price + "€</span>.");
                }

                // Daten-Anzeige aktualisieren
                eGridJourneys.option("dataSource", aJourneys);
            });

            e.preventDefault();
        });

        let eGridJourneys = $("#journeyTable").dxDataGrid({
            dataSource: aJourneys,
            keyExpr: "ID",
            allowColumnResizing: true,
            allowColumnReordering: true,
            filterRow: { visible: true },
            searchPanel: { visible: true },
            loadPanel: { enabled: true },

            pager: {
                showPageSizeSelector: true,
                allowedPageSizes: [10, 20, 50],
                showNavigationButtons: true
            },

            toolbar: {
                items: [
                    "searchPanel"
                ]
            },

            columns: [{
                dataField: "ID",
                visible: false,
                sortOrder: "asc"
            }, {
                dataField: "line",
                caption: "Linie"
            }, {
                dataField: "startStation",
                caption: "Abfahrts-Station"
            }, {
                dataField: "endStation",
                caption: "Ankunfts-Station"
            }, {
                dataField: "timeStart",
                caption: "Startzeit",
                dataType: "datetime",
            }, {
                dataField: "timeEnd",
                caption: "Endzeit",
                dataType: "datetime",
            }, {
                dataField: "timeWaiting",
                caption: "Wartezeit vom vorherigen Stop"
            }, {
                dataField: "timeTrip",
                caption: "Voraussichtliche Trip-Zeit"
            }],
            
            summary: {
                totalItems: [{
                    column: "plannedWhen",
                    summaryType: "count"
                }]
            }
        }).dxDataGrid("instance");
    </script>
    
    <!-- Toolbareinstellungen laden -->
    <script type="text/javascript" src="js/toolbar.js"></script>
</html>