<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" type="image/x-icon" href="img/favicon.ico">
        <title>DBAF - Karte</title>
        
        <!-- jQuery library -->
        <script type="text/javascript" src="dx_22.2.4/js/jquery.min.js"></script>
        <!-- DevExtreme theme -->
        <link rel="dx-theme" data-theme="generic.dark" href="dx_22.2.4/css/dx.dark.css" data-active="true">
        <!-- DevExtreme library -->
        <script type="text/javascript" src="dx_22.2.4/js/dx.all.js"></script>
        <script type="text/javascript" src="dx_22.2.4/js/vectormap-utils/dx.vectormaputils.js"></script>
        <!-- Dictionary files for German language -->
        <script src="dx_22.2.4/js/localization/dx.messages.de.js"></script>
        <!-- DBAF -->
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <script type="text/javascript" src="js/dbaf.js"></script>
        <script type="text/javascript" src="js/request.js"></script>
        <script type="text/javascript" src="js/ui.js"></script>
    </head>

    <body class="dx-viewport">
        <div class="dbaf-toolbar" id="toolbar"></div>

        <div class="dbaf-group-main">
            <!-- Übersicht der Seite -->
            <div class="dbaf-group">
                <h1>Karte</h1>
                <p>
                    Hier können alle Bahnhöfe gefiltert nach Bundesland in einer Karte übersichtlich eingesehen werden.<br>
                    Mit einem Klick auf eine Markierung lassen sich weitere Daten zu der ausgewählten Station einsehen.
                </p>
                <hr>
            </div>

            <!-- Eingabe des Bundeslandes -->
            <div class="dbaf-group">
                <div class="dbaf-drop-down" id="drop_down_federalstates"></div>
            </div>
            
            <!-- Datenübersicht (Karte) -->
            <div class="dbaf-group">
                <div class="dbaf-map" id="map"></div>
            </div>
        </div>
    </body>

    <!-- DBAF-TODO: Auskommentierung ab hier -->

    <script type="text/javascript">
        let aMarkersData = [];
        const sDefaultFederalState = "Sachsen-Anhalt";
        LoadStations(sDefaultFederalState);
        StickToClient("#map");

        function LoadStations(FederalState) {
            aMarkersData = [];

            let aStations = GetAllStations(FederalState, () => {
                for(let i = 0; i < aStations.length; i++) {
                    let aData = aStations[i];

                    if (aData.locLongitude != null && aData.locLatitude != null) {
                        aMarkersData.push({
                            "location": [aData.locLongitude, aData.locLatitude],
                            "tooltip": "<b>" + aData.name + "</b><br><br>" + aData.street + "<br>" + aData.zipcode + ", " + aData.city + "<br><br><a href=\"timetable.html?targetStation=" + aData.name + "\" target=\"_blank\">Abfahrten und Ankünfte zu diesem Bahnhof anzeigen</a>"
                        });
                    }
                }
                
                eMap.option("markers", aMarkersData);
            });
        }

        const eDropDownFederalStates = $("#drop_down_federalstates").dxDropDownBox({
            value: sDefaultFederalState,
            dataSource: EXT_FEDERALSTATES,
            contentTemplate: function (e) {
                var $list = $("<div>").dxList({
                    dataSource: EXT_FEDERALSTATES,
                    selectionMode: "single",
                    onSelectionChanged: function (args) {
                        e.component.option("value", args.addedItems[0]);
                        e.component.close();
                    }
                });
                return $list;
            }
        }).dxDropDownBox("instance");

        eDropDownFederalStates.on("valueChanged", () => {
            let sFederalState = eDropDownFederalStates.option("value");
            LoadStations(sFederalState);
        });

        const aMapTypes = [{
            key: "roadmap",
            name: "Road Map",
        }, {
            key: "satellite",
            name: "Satellite (Photographic) Map",
        }, {
            key: "hybrid",
            name: "Hybrid Map",
        }];

        const eMap = $("#map").dxMap({
            center: "Quedlinburg, Germany",
            controls: true,
            height: 10,
            zoom: 10,
            width: "100%",
            provider: "bing",
            type: aMapTypes[0].key,
            markers: aMarkersData,
            markerIconSrc: "img/map-marker.png"
        }).dxMap("instance");
    </script>
    
    <!-- Toolbareinstellungen laden -->
    <script type="text/javascript" src="js/toolbar.js"></script>
</html>